<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>India Gate AR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../css/mobile-ar.css">
  <style>
    /* Remove default grey circle from model-viewer hotspots */
    model-viewer::part(hotspot) {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
    }
    /* Custom style for visible hotspots */
    .hotspot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255, 180, 40, 0.848); /* semi-transparent red */
      border: 2px solid white;
      cursor: pointer;
      transition: opacity 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 8px rgba(0,0,0,0.15);
    }
    .hotspot.selected {
      background: rgb(255, 183, 0) !important;
      border-color: rgb(255, 255, 255);
      box-shadow: 0 0 16px 4px rgb(255, 145, 0);
    }
    /* If you want to hide all circles, use this instead: */
    /*
    .hotspot {
      background: transparent !important;
      border: none !important;
    }
    */
  </style>
  <!-- Model Viewer Library -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>
</head>
<body>
  <div class="container" style="max-width:480px;margin:auto;padding:16px;">
    <h1 style="font-size:1.5rem;text-align:center;">India Gate AR</h1>
    <div class="model-desc" style="margin-bottom:12px;">India Gate is a war memorial located in New Delhi, India. Explore its AR model below.</div>
    <model-viewer id="arModelViewer"
      alt="India Gate AR Model: 3D view of the India Gate war memorial, New Delhi, India."
      camera-controls auto-rotate
      style="width:100%;height:60vh;max-width:100vw;background:transparent;"
      draco-decoder-path="https://www.gstatic.com/draco/versioned/decoders/1.4.3/">
      <!-- Hotspots will be injected by JS -->
    </model-viewer>
  <!-- Hotspot List -->
  <ul class="hotspot-list" id="hotspotList"></ul>
  <button id="toggleHotspots" style="width:100%;margin:8px 0 8px 0;">Toggle Hotspots</button>
    <!-- Bottom Banner for Storytelling -->
    <div id="storyBanner" class="story-banner" style="display:none;">
      <button id="bannerClose" class="banner-exit" aria-label="Close">√ó</button>
      <div class="banner-content">
        <div class="banner-thumb-wrap">
          <img id="bannerThumb" class="banner-thumb" src="" alt="Hotspot thumbnail" tabindex="0"/>
        </div>
        <div class="banner-info">
          <div id="bannerTitle" class="banner-title"></div>
          <div id="bannerFact" class="banner-fact"></div>
          <div class="audio-controls">
            <button id="audioPlayPause" aria-label="Play/Pause">‚ñ∂Ô∏è</button>
            <input id="audioSeek" type="range" min="0" max="100" value="0" step="1" style="width:60%;vertical-align:middle;"/>
            <button id="audioMute" aria-label="Mute">üîä</button>
            <input id="audioVolume" type="range" min="0" max="1" value="1" step="0.01" style="width:20%;vertical-align:middle;"/>
          </div>
          <div id="bannerSubtitles" class="banner-subtitles"></div>
        </div>
      </div>
    </div>
    <!-- Fullscreen Thumbnail Modal -->
    <div id="thumbModal" class="thumb-modal" style="display:none;">
      <div class="thumb-modal-bg"></div>
      <img id="thumbModalImg" class="thumb-modal-img" src="" alt="Hotspot image fullscreen"/>
      <button id="thumbModalClose" class="thumb-modal-exit" aria-label="Close">√ó</button>
    </div>
    <a href="#" id="arLaunchLink" style="text-decoration:none;"><button style="width:100%;margin-top:16px;">Launch AR Experience</button></a>
    <button onclick="window.location.href='../index.html'" style="width:100%;margin-top:16px;">‚Üê Back to Menu</button>
  </div>
  <script>
    // --- AR Launch Logic ---
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }
    function isAndroidChrome() {
      return /Android/.test(navigator.userAgent) && /Chrome\//.test(navigator.userAgent);
    }
    function supportsSceneViewer() {
      return isAndroidChrome();
    }
  const GLB_URL = "https://kcpcvsfumkeinsxfkfru.supabase.co/storage/v1/object/public/heritage_assets/india_gate_nobg.glb";
  const USDZ_URL = "https://kcpcvsfumkeinsxfkfru.supabase.co/storage/v1/object/public/heritage_assets/india_gate.usdz";
    document.getElementById('arLaunchLink').onclick = function(e) {
      e.preventDefault();
      const viewer = document.getElementById('arModelViewer');
      // Remove hotspots for AR mode
      document.querySelectorAll('model-viewer .hotspot').forEach(h => h.style.display = 'none');
      if (isIOS()) {
        alert('Tip: On iOS, you can pinch to zoom and rotate the model in AR.');
        const a = document.createElement('a');
        a.setAttribute('rel', 'ar');
        a.setAttribute('href', USDZ_URL);
        a.setAttribute('style', 'display:none;');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(()=>{
          document.querySelectorAll('model-viewer .hotspot').forEach(h => h.style.display = '');
        }, 2000);
        return;
      }
      if (supportsSceneViewer()) {
        viewer.setAttribute('src', GLB_URL);
        viewer.setAttribute('ar', '');
        viewer.setAttribute('ar-modes', 'scene-viewer webxr');
        const glbUrl = GLB_URL;
        const title = encodeURIComponent('India Gate AR');
        const intentUrl = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(glbUrl)}&mode=ar_only&title=${title}&resizable=false#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;S.browser_fallback_url=${encodeURIComponent(window.location.href)};end;`;
        window.location.href = intentUrl;
        setTimeout(()=>{
          document.querySelectorAll('model-viewer .hotspot').forEach(h => h.style.display = '');
        }, 2000);
        return;
      }
      viewer.setAttribute('src', GLB_URL);
      viewer.setAttribute('ar', '');
      viewer.setAttribute('ar-modes', 'webxr');
      if (viewer && viewer.activateAR) {
        try {
          viewer.activateAR();
        } catch (err) {
          alert('AR not available. You can still interact with the 3D model below.');
        }
      } else {
        alert('AR not supported on this device/browser. You can still interact with the 3D model below.');
      }
      setTimeout(()=>{
        document.querySelectorAll('model-viewer .hotspot').forEach(h => h.style.display = '');
      }, 2000);
    };

    // --- Storytelling Feature ---
    const HOTSPOT_JSON_URL = 'https://kcpcvsfumkeinsxfkfru.supabase.co/storage/v1/object/public/data/india_gate_data.json';
  // (Removed duplicate GLB_URL and USDZ_URL declarations)
    let hotspotData = null;
    let currentAudio = null;
    let subtitleTimer = null;
    let selectedHotspot = null;

    // Load model and hotspots from JSON
    async function setupModelAndHotspots() {
      const res = await fetch(HOTSPOT_JSON_URL);
      const data = await res.json();
      hotspotData = data.hotspots;
      // Set model src
      const viewer = document.getElementById('arModelViewer');
      viewer.setAttribute('src', GLB_URL);
      // Inject hotspots immediately after src is set
      // Hotspot 3D positions (approximate, tweak as needed)
      const hotspotPositions = {
        'central_arch':    { position: '0 11 4', normal: '0 0 -1' }, // bottom center of arch
        'india_inscription': { position: '0 15 4', normal: '0 0 -1' }, // vertical middle/top (INDIA)
        'amar_jawan':     { position: '0 0.5 0.7', normal: '0 0 -1' }, // front, below arch
        'soldier_names':  { position: '-4 7 4', normal: '-1 0 0' }, // left front surface
        'canopy_area':    { position: '0 2.1 -5', normal: '0 0 1' } // behind, top center
      };
      hotspotData.forEach(h => {
        const btn = document.createElement('button');
        btn.className = 'hotspot';
        btn.setAttribute('slot', 'hotspot-' + h.id); // Use slot='hotspot-<id>' for model-viewer
        btn.setAttribute('data-hotspot', h.id);
        btn.setAttribute('aria-label', h.title);
        // Set 3D position and normal if defined
        const pos = hotspotPositions[h.id];
        if (pos) {
          btn.setAttribute('data-position', pos.position);
          btn.setAttribute('data-normal', pos.normal);
        }
        btn.onclick = () => onHotspotClick(h.id);
        btn.style.opacity = '0.35';
        viewer.appendChild(btn);
      });
      // Listen for model-viewer 'hotspot-visibility' event to update all opacities
      function updateHotspotOpacities(visibleMap) {
        document.querySelectorAll('model-viewer .hotspot').forEach(btn => {
          const slot = btn.getAttribute('slot');
          if (visibleMap && visibleMap[slot]) {
            btn.style.opacity = '1';
          } else {
            btn.style.opacity = '0.35';
          }
        });
      }
      viewer.addEventListener('hotspot-visibility', e => {
        updateHotspotOpacities(e.detail.visible);
      });
      // Fallback: update opacities every frame if event not supported
      function fallbackHotspotOpacity() {
        if (!window.modelViewerHotspotVisibilitySupported) {
          document.querySelectorAll('model-viewer .hotspot').forEach(btn => {
            btn.style.opacity = '1';
          });
        }
      }
      setInterval(fallbackHotspotOpacity, 1000);
      // Hotspot toggle button
      let hotspotsVisible = true;
      document.getElementById('toggleHotspots').onclick = function() {
        hotspotsVisible = !hotspotsVisible;
        document.querySelectorAll('model-viewer .hotspot').forEach(btn => {
          btn.style.display = hotspotsVisible ? '' : 'none';
        });
      };
      // Add hotspot list
      const list = document.getElementById('hotspotList');
      list.innerHTML = '';
      hotspotData.forEach(h => {
        const li = document.createElement('li');
        li.className = 'hotspot-list-item';
        li.setAttribute('data-hotspot', h.id);
        li.innerHTML = `${h.title} <button class="hotspot-audio-btn" aria-label="Play audio"><span>üîä</span></button>`;
        li.querySelector('.hotspot-audio-btn').onclick = (e) => {
          e.stopPropagation();
          playHotspotAudio(h.id);
        };
        li.onclick = () => onHotspotClick(h.id);
        list.appendChild(li);
      });
    }

    // Highlight logic
    function highlightHotspot(key) {
      document.querySelectorAll('.hotspot').forEach(btn => {
        if (btn.dataset.hotspot === key) btn.classList.add('selected');
        else btn.classList.remove('selected');
      });
      document.querySelectorAll('.hotspot-list-item').forEach(li => {
        if (li.dataset.hotspot === key) li.classList.add('selected');
        else li.classList.remove('selected');
      });
      selectedHotspot = key;
    }

    // Play audio for a hotspot
    function playHotspotAudio(hotspotId) {
      const h = hotspotData.find(hh => hh.id === hotspotId);
      if (!h) return;
      if (currentAudio) { currentAudio.pause(); currentAudio = null; }
      const audio = new Audio(h.audio.en);
      audio.preload = 'auto';
      audio.volume = 1;
      currentAudio = audio;
      audio.play();
    }

    // Hotspot click handler
    function onHotspotClick(hotspotId) {
      highlightHotspot(hotspotId);
      const h = hotspotData.find(hh => hh.id === hotspotId);
      if (!h) return;
      // Lazy-load audio
      if (currentAudio) { currentAudio.pause(); currentAudio = null; }
      const audio = new Audio(h.audio.en);
      audio.preload = 'auto';
      audio.volume = 1;
      currentAudio = audio;
      // Banner UI
      document.getElementById('bannerTitle').textContent = h.title;
      document.getElementById('bannerFact').textContent = h.fact;
      const thumb = document.getElementById('bannerThumb');
      thumb.src = h.image;
      thumb.alt = h.title + ' thumbnail';
      // Subtitles (not in sample JSON, so leave blank)
      document.getElementById('bannerSubtitles').textContent = '';
      // Show banner
      document.getElementById('storyBanner').style.display = 'block';
      setTimeout(()=>{
        document.getElementById('storyBanner').style.transform = 'translateY(0)';
      }, 10);
      // Audio controls
      const playBtn = document.getElementById('audioPlayPause');
      const seekBar = document.getElementById('audioSeek');
      const muteBtn = document.getElementById('audioMute');
      const volBar = document.getElementById('audioVolume');
      playBtn.textContent = '‚ñ∂Ô∏è';
      playBtn.onclick = () => {
        if (audio.paused) { audio.play(); } else { audio.pause(); }
      };
      audio.onplay = () => { playBtn.textContent = '‚è∏Ô∏è'; };
      audio.onpause = () => { playBtn.textContent = '‚ñ∂Ô∏è'; };
      audio.onended = () => { playBtn.textContent = '‚ñ∂Ô∏è'; };
      // Seek
      audio.ontimeupdate = () => {
        seekBar.value = (audio.currentTime / audio.duration) * 100 || 0;
      };
      seekBar.oninput = () => {
        audio.currentTime = (seekBar.value / 100) * audio.duration;
      };
      // Volume
      volBar.value = audio.volume;
      volBar.oninput = () => { audio.volume = volBar.value; };
      muteBtn.onclick = () => {
        audio.muted = !audio.muted;
        muteBtn.textContent = audio.muted ? 'üîá' : 'üîä';
      };
      // Fullscreen thumbnail
      thumb.onclick = () => {
        document.getElementById('thumbModalImg').src = h.image;
        document.getElementById('thumbModal').style.display = 'flex';
      };
    }

    // Banner exit
    document.getElementById('bannerClose').onclick = () => {
      document.getElementById('storyBanner').style.transform = '';
      setTimeout(()=>{
        document.getElementById('storyBanner').style.display = 'none';
      }, 200);
      if (currentAudio) { currentAudio.pause(); currentAudio = null; }
      highlightHotspot(null);
    };
    // Fullscreen modal exit
    document.getElementById('thumbModalClose').onclick = () => {
      document.getElementById('thumbModal').style.display = 'none';
    };
    document.querySelector('.thumb-modal-bg').onclick = () => {
      document.getElementById('thumbModal').style.display = 'none';
    };
    // Accessibility: close modal with Esc
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.getElementById('thumbModal').style.display = 'none';
      }
    });

    // On page load, setup model and hotspots
    setupModelAndHotspots();
    // Banner exit
    document.getElementById('bannerClose').onclick = () => {
      document.getElementById('storyBanner').style.transform = '';
      setTimeout(()=>{
        document.getElementById('storyBanner').style.display = 'none';
      }, 200);
      if (currentAudio) { currentAudio.pause(); currentAudio = null; }
      if (subtitleTimer) clearInterval(subtitleTimer);
      highlightHotspot(null);
    };
    // Fullscreen modal exit
    document.getElementById('thumbModalClose').onclick = () => {
      document.getElementById('thumbModal').style.display = 'none';
    };
    document.querySelector('.thumb-modal-bg').onclick = () => {
      document.getElementById('thumbModal').style.display = 'none';
    };
    // Accessibility: close modal with Esc
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.getElementById('thumbModal').style.display = 'none';
      }
    });
    // ...existing code for AR launch...
  </script>
</body>
</html>
