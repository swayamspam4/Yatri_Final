<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Charminar AR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../css/mobile-ar.css">
  <style>
    model-viewer::part(hotspot) { background: none !important; border: none !important; box-shadow: none !important; }
    .hotspot { width: 24px; height: 24px; border-radius: 50%; background: rgba(255, 180, 40, 0.848); border: 2px solid white; cursor: pointer; transition: opacity 0.2s, box-shadow 0.2s; box-shadow: 0 0 8px rgba(0,0,0,0.15); }
    .hotspot.selected { background: rgb(255, 183, 0) !important; border-color: rgb(255, 255, 255); box-shadow: 0 0 16px 4px rgb(255, 145, 0); }
  </style>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>
</head>
<body>
  <div class="container" style="max-width:480px;margin:auto;padding:16px;">
    <h1 style="font-size:1.5rem;text-align:center;">Charminar AR</h1>
    <div class="model-desc" style="margin-bottom:12px;">Charminar is a historic monument in Hyderabad, India. Explore its AR model below.</div>
    <model-viewer id="arModelViewer"
      alt="Charminar AR Model: 3D view of the Charminar monument, Hyderabad, India."
      camera-controls auto-rotate
      style="width:100%;height:60vh;max-width:100vw;background:transparent;"
      draco-decoder-path="https://www.gstatic.com/draco/versioned/decoders/1.4.3/">
      <!-- Hotspots will be injected by JS -->
    </model-viewer>
    <ul class="hotspot-list" id="hotspotList"></ul>
    <button id="toggleHotspots" style="width:100%;margin:8px 0 8px 0;">Toggle Hotspots</button>
    <!-- Bottom Banner for Storytelling -->
    <div id="storyBanner" class="story-banner" style="display:none;">
      <button id="bannerClose" class="banner-exit" aria-label="Close">√ó</button>
      <div class="banner-content">
        <div class="banner-thumb-wrap">
          <img id="bannerThumb" class="banner-thumb" src="" alt="Hotspot thumbnail" tabindex="0"/>
        </div>
        <div class="banner-info">
          <div id="bannerTitle" class="banner-title"></div>
          <div id="bannerFact" class="banner-fact"></div>
          <div class="audio-controls">
            <button id="audioPlayPause" aria-label="Play/Pause">‚ñ∂Ô∏è</button>
            <input id="audioSeek" type="range" min="0" max="100" value="0" step="1" style="width:60%;vertical-align:middle;"/>
            <button id="audioMute" aria-label="Mute">üîä</button>
            <input id="audioVolume" type="range" min="0" max="1" value="1" step="0.01" style="width:20%;vertical-align:middle;"/>
          </div>
          <div id="bannerSubtitles" class="banner-subtitles"></div>
        </div>
      </div>
    </div>
    <!-- Fullscreen Thumbnail Modal -->
    <div id="thumbModal" class="thumb-modal" style="display:none;">
      <div class="thumb-modal-bg"></div>
      <img id="thumbModalImg" class="thumb-modal-img" src="" alt="Hotspot image fullscreen"/>
      <button id="thumbModalClose" class="thumb-modal-exit" aria-label="Close">√ó</button>
    </div>
    <a href="#" id="arLaunchLink" style="text-decoration:none;"><button style="width:100%;margin-top:16px;">Launch AR Experience</button></a>
    <button onclick="window.location.href='../index.html'" style="width:100%;margin-top:16px;">‚Üê Back to Menu</button>
  </div>
  <script>
    // --- AR Launch Logic ---
    function isIOS() { return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }
    function isAndroidChrome() { return /Android/.test(navigator.userAgent) && /Chrome\//.test(navigator.userAgent); }
    function supportsSceneViewer() { return isAndroidChrome(); }
    const GLB_URL = "https://kcpcvsfumkeinsxfkfru.supabase.co/storage/v1/object/public/heritage_assets/charminar_hyderabad.glb";
    const USDZ_URL = "https://kcpcvsfumkeinsxfkfru.supabase.co/storage/v1/object/public/heritage_assets/Charminar_Hyderabad.usdz";
    document.getElementById('arLaunchLink').onclick = function(e) {
      e.preventDefault();
      const viewer = document.getElementById('arModelViewer');
      document.querySelectorAll('model-viewer .hotspot').forEach(h => h.style.display = 'none');
      if (isIOS()) {
        alert('Tip: On iOS, you can pinch to zoom and rotate the model in AR.');
        const a = document.createElement('a');
        a.setAttribute('rel', 'ar');
        a.setAttribute('href', USDZ_URL);
        a.setAttribute('style', 'display:none;');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(()=>{ document.querySelectorAll('model-viewer .hotspot').forEach(h => h.style.display = ''); }, 2000);
        return;
      }
      if (supportsSceneViewer()) {
        viewer.setAttribute('src', GLB_URL);
        viewer.setAttribute('ar', '');
        viewer.setAttribute('ar-modes', 'scene-viewer webxr');
        const glbUrl = GLB_URL;
        const title = encodeURIComponent('Charminar AR');
        const intentUrl = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(glbUrl)}&mode=ar_only&title=${title}&resizable=false#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;S.browser_fallback_url=${encodeURIComponent(window.location.href)};end;`;
        window.location.href = intentUrl;
        setTimeout(()=>{ document.querySelectorAll('model-viewer .hotspot').forEach(h => h.style.display = ''); }, 2000);
        return;
      }
      viewer.setAttribute('src', GLB_URL);
      viewer.setAttribute('ar', '');
      viewer.setAttribute('ar-modes', 'webxr');
      if (viewer && viewer.activateAR) {
        try { viewer.activateAR(); } catch (err) { alert('AR not available. You can still interact with the 3D model below.'); }
      } else { alert('AR not supported on this device/browser. You can still interact with the 3D model below.'); }
      setTimeout(()=>{ document.querySelectorAll('model-viewer .hotspot').forEach(h => h.style.display = ''); }, 2000);
    };
    // --- Storytelling Feature ---
    // TODO: Add hotspots and storytelling data for this monument.
    // Banner exit
    document.getElementById('bannerClose').onclick = () => {
      document.getElementById('storyBanner').style.transform = '';
      setTimeout(()=>{ document.getElementById('storyBanner').style.display = 'none'; }, 200);
    };
    // Fullscreen modal exit
    document.getElementById('thumbModalClose').onclick = () => { document.getElementById('thumbModal').style.display = 'none'; };
    document.querySelector('.thumb-modal-bg').onclick = () => { document.getElementById('thumbModal').style.display = 'none'; };
    document.addEventListener('keydown', e => { if (e.key === 'Escape') { document.getElementById('thumbModal').style.display = 'none'; } });
    // Set model src on load
    document.getElementById('arModelViewer').setAttribute('src', GLB_URL);
  </script>
</body>
</html>
