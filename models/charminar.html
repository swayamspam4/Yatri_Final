<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Charminar AR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../css/mobile-ar.css">
  <style>
    model-viewer::part(hotspot) { background: none !important; border: none !important; box-shadow: none !important; }
    .hotspot { width: 24px; height: 24px; border-radius: 50%; background: rgba(255, 180, 40, 0.848); border: 2px solid white; cursor: pointer; transition: opacity 0.2s, box-shadow 0.2s; box-shadow: 0 0 8px rgba(0,0,0,0.15); }
    .hotspot.selected { background: rgb(255, 183, 0) !important; border-color: rgb(255, 255, 255); box-shadow: 0 0 16px 4px rgb(255, 145, 0); }
  </style>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>
</head>
<body>
  <div class="container" style="max-width:480px;margin:auto;padding:16px;">
    <h1 style="font-size:1.5rem;text-align:center;">Charminar AR</h1>
    <div class="model-desc" style="margin-bottom:12px;">Charminar is a historic monument in Hyderabad, India. Explore its AR model below.</div>
    <model-viewer id="arModelViewer"
      alt="Charminar AR Model: 3D view of the Charminar monument, Hyderabad, India."
      camera-controls auto-rotate
      style="width:100%;height:60vh;max-width:100vw;background:transparent;"
      draco-decoder-path="https://www.gstatic.com/draco/versioned/decoders/1.4.3/">
      <!-- Hotspots will be injected by JS -->
    </model-viewer>
    <ul class="hotspot-list" id="hotspotList"></ul>
    <button id="toggleHotspots" style="width:100%;margin:8px 0 8px 0;">Toggle Hotspots</button>
    <!-- Bottom Banner for Storytelling -->
    <div id="storyBanner" class="story-banner" style="display:none;">
      <button id="bannerClose" class="banner-exit" aria-label="Close">√ó</button>
      <div class="banner-content">
        <div class="banner-thumb-wrap">
          <img id="bannerThumb" class="banner-thumb" src="" alt="Hotspot thumbnail" tabindex="0"/>
        </div>
        <div class="banner-info">
          <div id="bannerTitle" class="banner-title"></div>
          <div id="bannerFact" class="banner-fact"></div>
          <div class="audio-controls">
            <button id="audioPlayPause" aria-label="Play/Pause">‚ñ∂Ô∏è</button>
            <input id="audioSeek" type="range" min="0" max="100" value="0" step="1" style="width:60%;vertical-align:middle;"/>
            <button id="audioMute" aria-label="Mute">üîä</button>
            <input id="audioVolume" type="range" min="0" max="1" value="1" step="0.01" style="width:20%;vertical-align:middle;"/>
          </div>
          <div id="bannerSubtitles" class="banner-subtitles"></div>
        </div>
      </div>
    </div>
    <!-- Fullscreen Thumbnail Modal -->
    <div id="thumbModal" class="thumb-modal" style="display:none;">
      <div class="thumb-modal-bg"></div>
      <img id="thumbModalImg" class="thumb-modal-img" src="" alt="Hotspot image fullscreen"/>
      <button id="thumbModalClose" class="thumb-modal-exit" aria-label="Close">√ó</button>
    </div>
    <a href="#" id="arLaunchLink" style="text-decoration:none;"><button style="width:100%;margin-top:16px;">Launch AR Experience</button></a>
    <button onclick="window.location.href='../index.html'" style="width:100%;margin-top:16px;">‚Üê Back to Menu</button>
  </div>
  <script>
    // --- AR Launch Logic ---
    function isIOS() { return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }
    function isAndroidChrome() { return /Android/.test(navigator.userAgent) && /Chrome\//.test(navigator.userAgent); }
    function supportsSceneViewer() { return isAndroidChrome(); }
    const GLB_URL = "https://kcpcvsfumkeinsxfkfru.supabase.co/storage/v1/object/public/heritage_assets/charminar_hyderabad.glb";
    const USDZ_URL = "https://kcpcvsfumkeinsxfkfru.supabase.co/storage/v1/object/public/heritage_assets/Charminar_Hyderabad.usdz";
    document.getElementById('arLaunchLink').onclick = function(e) {
      e.preventDefault();
      const viewer = document.getElementById('arModelViewer');
      document.querySelectorAll('model-viewer .hotspot').forEach(h => h.style.display = 'none');
      if (isIOS()) {
        alert('Tip: On iOS, you can pinch to zoom and rotate the model in AR.');
        const a = document.createElement('a');
        a.setAttribute('rel', 'ar');
        a.setAttribute('href', USDZ_URL);
        a.setAttribute('style', 'display:none;');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(()=>{ document.querySelectorAll('model-viewer .hotspot').forEach(h => h.style.display = ''); }, 2000);
        return;
      }
      if (supportsSceneViewer()) {
        viewer.setAttribute('src', GLB_URL);
        viewer.setAttribute('ar', '');
        viewer.setAttribute('ar-modes', 'scene-viewer webxr');
        const glbUrl = GLB_URL;
        const title = encodeURIComponent('Charminar AR');
        const intentUrl = `intent://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(glbUrl)}&mode=ar_only&title=${title}&resizable=false#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;S.browser_fallback_url=${encodeURIComponent(window.location.href)};end;`;
        window.location.href = intentUrl;
        setTimeout(()=>{ document.querySelectorAll('model-viewer .hotspot').forEach(h => h.style.display = ''); }, 2000);
        return;
      }
      viewer.setAttribute('src', GLB_URL);
      viewer.setAttribute('ar', '');
      viewer.setAttribute('ar-modes', 'webxr');
      if (viewer && viewer.activateAR) {
        try { viewer.activateAR(); } catch (err) { alert('AR not available. You can still interact with the 3D model below.'); }
      } else { alert('AR not supported on this device/browser. You can still interact with the 3D model below.'); }
      setTimeout(()=>{ document.querySelectorAll('model-viewer .hotspot').forEach(h => h.style.display = ''); }, 2000);
    };
    // --- Storytelling Feature ---
    const HOTSPOT_JSON_URL = 'https://kcpcvsfumkeinsxfkfru.supabase.co/storage/v1/object/public/Charminar/charminar_data.json';
    let hotspotData = null;
    let currentAudio = null;
    let selectedHotspot = null;
    let currentSlideIdx = 0;
    let currentSlides = null;
    // Hotspot 3D positions for Charminar
    const hotspotPositions = {
      'charminar_story': { position: '0 10 0', normal: '0 1 0' },
      'central_arch': { position: '0 5 7', normal: '0 0 -1' },
      'four_minarets_1': { position: '5 0 5', normal: '1 0 0' },
      'four_minarets_2': { position: '-5 0 5', normal: '-1 0 0' },
      'four_minarets_3': { position: '5 0 -5', normal: '1 0 0' },
      'four_minarets_4': { position: '-5 0 -5', normal: '-1 0 0' },
      'why_famous': { position: '0 13 0', normal: '0 1 0' },
      'secret_tunnel': { position: '0 -2 -7', normal: '0 -1 0' }
    };
    async function setupModelAndHotspots() {
      const res = await fetch(HOTSPOT_JSON_URL);
      const data = await res.json();
      hotspotData = data.hotspots;
      const viewer = document.getElementById('arModelViewer');
      viewer.setAttribute('src', GLB_URL);
      // Place hotspots
      hotspotData.forEach(h => {
        if (h.id === 'four_minarets') {
          for (let i = 1; i <= 4; i++) {
            const btn = document.createElement('button');
            btn.className = 'hotspot';
            btn.setAttribute('slot', 'hotspot-four_minarets_' + i);
            btn.setAttribute('data-hotspot', h.id + '_' + i);
            btn.setAttribute('aria-label', h.title + ' ' + i);
            const pos = hotspotPositions['four_minarets_' + i];
            if (pos) {
              btn.setAttribute('data-position', pos.position);
              btn.setAttribute('data-normal', pos.normal);
            }
            btn.onclick = () => onHotspotClick(h.id, i);
            btn.style.opacity = '1';
            viewer.appendChild(btn);
          }
        } else {
          const btn = document.createElement('button');
          btn.className = 'hotspot';
          btn.setAttribute('slot', 'hotspot-' + h.id);
          btn.setAttribute('data-hotspot', h.id);
          btn.setAttribute('aria-label', h.title);
          const pos = hotspotPositions[h.id];
          if (pos) {
            btn.setAttribute('data-position', pos.position);
            btn.setAttribute('data-normal', pos.normal);
          }
          btn.onclick = () => onHotspotClick(h.id);
          btn.style.opacity = '1';
          viewer.appendChild(btn);
        }
      });
      // Hotspot toggle button
      let hotspotsVisible = true;
      document.getElementById('toggleHotspots').onclick = function() {
        hotspotsVisible = !hotspotsVisible;
        document.querySelectorAll('model-viewer .hotspot').forEach(btn => {
          btn.style.display = hotspotsVisible ? '' : 'none';
        });
      };
      // Add hotspot list
      const list = document.getElementById('hotspotList');
      list.innerHTML = '';
      hotspotData.forEach(h => {
        if (h.id === 'four_minarets') {
          for (let i = 1; i <= 4; i++) {
            const li = document.createElement('li');
            li.className = 'hotspot-list-item';
            li.setAttribute('data-hotspot', h.id + '_' + i);
            li.textContent = h.title + ' ' + i;
            li.onclick = () => onHotspotClick(h.id, i);
            list.appendChild(li);
          }
        } else {
          const li = document.createElement('li');
          li.className = 'hotspot-list-item';
          li.setAttribute('data-hotspot', h.id);
          li.textContent = h.title;
          li.onclick = () => onHotspotClick(h.id);
          list.appendChild(li);
        }
      });
    }
    // Highlight logic
    function highlightHotspot(key) {
      document.querySelectorAll('.hotspot').forEach(btn => {
        if (btn.dataset.hotspot === key) btn.classList.add('selected');
        else btn.classList.remove('selected');
      });
      document.querySelectorAll('.hotspot-list-item').forEach(li => {
        if (li.dataset.hotspot === key) li.classList.add('selected');
        else li.classList.remove('selected');
      });
      selectedHotspot = key;
    }
    // Hotspot click handler
    function onHotspotClick(hotspotId, minaretNum) {
      highlightHotspot(minaretNum ? hotspotId + '_' + minaretNum : hotspotId);
      let h = null;
      currentSlideIdx = 0;
      currentSlides = null;
      if (minaretNum) {
        h = hotspotData.find(hh => hh.id === 'four_minarets');
        if (h && h.slides && h.slides[minaretNum - 1]) {
          currentSlides = h.slides;
          showBanner(h.title + ' ' + minaretNum, h.slides[minaretNum - 1], minaretNum - 1, h.slides.length);
        }
      } else {
        h = hotspotData.find(hh => hh.id === hotspotId);
        if (!h) return;
        if (h.slides) {
          currentSlides = h.slides;
          showBanner(h.title, h.slides[0], 0, h.slides.length);
        } else {
          showBanner(h.title, h, 0, 1);
        }
      }
    }
    // Banner UI logic
    function showBanner(title, slide, idx, totalSlides) {
      document.getElementById('bannerTitle').textContent = title;
      document.getElementById('bannerFact').textContent = slide.fact;
      const thumb = document.getElementById('bannerThumb');
      thumb.src = slide.image || '';
      thumb.alt = title + ' thumbnail';
      document.getElementById('bannerSubtitles').textContent = slide.subtitles || '';
      document.getElementById('storyBanner').style.display = 'block';
      setTimeout(()=>{ document.getElementById('storyBanner').style.transform = 'translateY(0)'; }, 10);
      // Slide navigation
      let nav = document.getElementById('bannerNav');
      if (!nav) {
        nav = document.createElement('div');
        nav.id = 'bannerNav';
        nav.style = 'display:flex;justify-content:center;align-items:center;margin:8px 0;';
        document.querySelector('.banner-info').appendChild(nav);
      }
      nav.innerHTML = '';
      if (totalSlides > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.textContent = '‚ü®';
        prevBtn.style.marginRight = '8px';
        prevBtn.disabled = idx === 0;
        prevBtn.onclick = () => {
          currentSlideIdx = idx - 1;
          showBanner(title, currentSlides[currentSlideIdx], currentSlideIdx, totalSlides);
        };
        nav.appendChild(prevBtn);
        const slideInfo = document.createElement('span');
        slideInfo.textContent = `Slide ${idx + 1} of ${totalSlides}`;
        nav.appendChild(slideInfo);
        const nextBtn = document.createElement('button');
        nextBtn.textContent = '‚ü©';
        nextBtn.style.marginLeft = '8px';
        nextBtn.disabled = idx === totalSlides - 1;
        nextBtn.onclick = () => {
          currentSlideIdx = idx + 1;
          showBanner(title, currentSlides[currentSlideIdx], currentSlideIdx, totalSlides);
        };
        nav.appendChild(nextBtn);
      }
      // Audio controls (English only for now)
      if (slide.audio && slide.audio.en) {
        if (currentAudio) { currentAudio.pause(); currentAudio = null; }
        const audio = new Audio(slide.audio.en);
        audio.preload = 'auto';
        audio.volume = 1;
        currentAudio = audio;
        // Controls
        const playBtn = document.getElementById('audioPlayPause');
        const seekBar = document.getElementById('audioSeek');
        const muteBtn = document.getElementById('audioMute');
        const volBar = document.getElementById('audioVolume');
        playBtn.textContent = '‚ñ∂Ô∏è';
        playBtn.onclick = () => { if (audio.paused) { audio.play(); } else { audio.pause(); } };
        audio.onplay = () => { playBtn.textContent = '‚è∏Ô∏è'; };
        audio.onpause = () => { playBtn.textContent = '‚ñ∂Ô∏è'; };
        audio.onended = () => { playBtn.textContent = '‚ñ∂Ô∏è'; };
        audio.ontimeupdate = () => { seekBar.value = (audio.currentTime / audio.duration) * 100 || 0; };
        seekBar.oninput = () => { audio.currentTime = (seekBar.value / 100) * audio.duration; };
        volBar.value = audio.volume;
        volBar.oninput = () => { audio.volume = volBar.value; };
        muteBtn.onclick = () => { audio.muted = !audio.muted; muteBtn.textContent = audio.muted ? 'üîá' : 'üîä'; };
      }
      // Fullscreen thumbnail
      thumb.onclick = () => {
        document.getElementById('thumbModalImg').src = slide.image || '';
        document.getElementById('thumbModal').style.display = 'flex';
      };
    }
    // Banner exit
    document.getElementById('bannerClose').onclick = () => {
      document.getElementById('storyBanner').style.transform = '';
      setTimeout(()=>{ document.getElementById('storyBanner').style.display = 'none'; }, 200);
      if (currentAudio) { currentAudio.pause(); currentAudio = null; }
      highlightHotspot(null);
      currentSlideIdx = 0;
      currentSlides = null;
    };
    // Fullscreen modal exit
    document.getElementById('thumbModalClose').onclick = () => { document.getElementById('thumbModal').style.display = 'none'; };
    document.querySelector('.thumb-modal-bg').onclick = () => { document.getElementById('thumbModal').style.display = 'none'; };
    document.addEventListener('keydown', e => { if (e.key === 'Escape') { document.getElementById('thumbModal').style.display = 'none'; } });
    // On page load, setup model and hotspots
    setupModelAndHotspots();
    // Banner exit
    document.getElementById('bannerClose').onclick = () => {
      document.getElementById('storyBanner').style.transform = '';
      setTimeout(()=>{ document.getElementById('storyBanner').style.display = 'none'; }, 200);
    };
    // Fullscreen modal exit
    document.getElementById('thumbModalClose').onclick = () => { document.getElementById('thumbModal').style.display = 'none'; };
    document.querySelector('.thumb-modal-bg').onclick = () => { document.getElementById('thumbModal').style.display = 'none'; };
    document.addEventListener('keydown', e => { if (e.key === 'Escape') { document.getElementById('thumbModal').style.display = 'none'; } });
    // Set model src on load
    document.getElementById('arModelViewer').setAttribute('src', GLB_URL);
  </script>
</body>
</html>
